<div class="grid">
    <div class="col-12">
        <div class="card">
            <p-toast></p-toast>
            <p-toolbar styleClass="mb-4">
                <ng-template pTemplate="left">
                    <div class="my-2">
                        <button *ngIf="hasPermission(actions.add)" pButton pRipple label="{{'shared.actions.new' | translate }}" icon="pi pi-plus" class="p-button-success mr-2" (click)="openNew()"></button>
                        <button *ngIf="hasPermission(actions.delete)" pButton pRipple label="{{'shared.actions.delete' | translate }}" icon="pi pi-trash" class="p-button-danger" (click)="deleteSelectedReminders()" [disabled]="!selectedReminders.length"></button>
                    </div>
                </ng-template>
            </p-toolbar>
            <p-table #dt [value]="reminders" [columns]="cols" responsiveLayout="scroll" [rows]="10" [paginator]="true"
                [rowsPerPageOptions]="[10,20,30]" [(selection)]="selectedReminders" selectionMode="multiple">
                <ng-template pTemplate="caption">
                    <div class="flex flex-column md:flex-row md:justify-content-between md:align-items-center">
                        <h5 class="m-0">{{ 'subscription.payment-reminder-list.title' | translate}}</h5>
                        <span class="block mt-2 md:mt-0 p-input-icon-left">
                            <i class="pi pi-search"></i>
                            <input pInputText type="text" (input)="onGlobalFilter(dt, $event)" placeholder="{{'shared.actions.search' | translate }}"
                                class="w-full sm:w-auto" />
                        </span>
                    </div>
                </ng-template>
                <ng-template pTemplate="header">
                    <tr>
                        <th style="width: 3rem">
                            <p-tableHeaderCheckbox></p-tableHeaderCheckbox>
                        </th>
                        <th *ngFor="let col of cols" [pSortableColumn]="col.field">
                            {{col.header}}
                            <p-sortIcon [field]="col.field"></p-sortIcon>
                        </th>

                        <th>{{ 'subscription.payment-reminder-list.fields.daysBeforePayment' | translate}}</th>

                        <th>{{ 'subscription.payment-reminder-list.fields.status' | translate}}</th>
                        <th ></th>
                    </tr>
                </ng-template>
                <ng-template pTemplate="body" let-reminder>
                    <tr>
                        <td>
                            <p-tableCheckbox [value]="reminder"></p-tableCheckbox>
                        </td>
                        <td *ngFor="let col of cols">
                            {{reminder[col.field]}}
                        </td>
                        <td>
                            {{reminder.beforePayCount}}
                        </td>
                        <td>
                            <p-inputSwitch *ngIf="hasPermission(actions.active)" [ngModel]="reminder.isActive"
                                (click)="openActivationDialog(reminder)"></p-inputSwitch>
                        </td>

                        <td class="text-right">
                            <button *ngIf="menuItems.length > 0" pButton pRipple type="button" icon="pi pi-ellipsis-v"
                                class="p-button-rounded p-button-text p-button-plain ml-3"
                                (click)="menu.toggle($event); assigneCurrentSelect(reminder)"></button>
                              <p-menu #menu [model]="menuItems" [appendTo]="dt" [popup]="true"></p-menu>
                        </td>
                    </tr>
                </ng-template>
            </p-table>
        </div>
    </div>
</div>

<p-dialog [(visible)]="reminderDialog" [style]="{width: '450px'}" header="{{'subscription.payment-reminder-list.dialogs.reminderDialog.header' | translate}}" [modal]="true"
    class="p-fluid">
    <ng-template pTemplate="content">

        <form [formGroup]="reminderForm" (ngSubmit)="saveReminder()">

            <div class="field">
                <label for="title">{{'subscription.payment-reminder-list.dialogs.reminderDialog.fields.title' | translate}}</label>
                <input type="text" pInputText id="title" formControlName="title" required autofocus
                    [ngClass]="{'ng-invalid ng-dirty' : submitted && !reminderForm.controls['title'].valid}" />
                <small *ngIf="submitted && !reminderForm.controls['title'].valid"
                    class="ng-dirty ng-invalid text-red-500">{{'subscription.payment-reminder-list.dialogs.reminderDialog.validations.title' | translate}}</small>
            </div>

            <div class="field">
                <label for="subject">{{'subscription.payment-reminder-list.dialogs.reminderDialog.fields.subject' | translate}}</label>
                <input type="text" pInputText id="subject" formControlName="subject" required
                    [ngClass]="{'ng-invalid ng-dirty' : submitted && !reminderForm.controls['subject'].valid}" />
                <small *ngIf="submitted && !reminderForm.controls['subject'].valid"
                    class="ng-dirty ng-invalid text-red-500">{{'subscription.payment-reminder-list.dialogs.reminderDialog.validations.subject' | translate}}</small>
            </div>

            <div class="field">
                <label for="message">{{'subscription.payment-reminder-list.dialogs.reminderDialog.fields.message' | translate}}</label>
                <textarea id="message" formControlName="message" pInputTextarea required
                    [ngClass]="{'ng-invalid ng-dirty' : submitted && !reminderForm.controls['message'].valid}" rows="3"
                    cols="20"></textarea>
                <small *ngIf="submitted && !reminderForm.controls['message'].valid"
                    class="ng-dirty ng-invalid text-red-500">{{'subscription.payment-reminder-list.dialogs.reminderDialog.validations.message' | translate}}</small>
            </div>

            <div class="field">
                <label for="beforePayCount">{{'subscription.payment-reminder-list.dialogs.reminderDialog.fields.daysBeforePayment' | translate}}</label>
                <p-inputNumber id="beforePayCount" formControlName="beforePayCount"
                    [ngClass]="{'ng-invalid ng-dirty' : submitted && !reminderForm.controls['beforePayCount'].valid}"></p-inputNumber>
                <small *ngIf="submitted && !reminderForm.controls['beforePayCount'].valid"
                    class="ng-dirty ng-invalid text-red-500">{{'subscription.payment-reminder-list.dialogs.reminderDialog.validations.daysBeforePayment' | translate}}</small>
            </div>
        </form>

    </ng-template>
    <ng-template pTemplate="footer">
        <button pButton pRipple label="{{ 'shared.actions.cancel' | translate }}" icon="pi pi-times" class="p-button-text" (click)="hideDialog()"></button>
        <button pButton pRipple label="{{ 'shared.actions.save' | translate }}" icon="pi pi-check" class="p-button-text" (click)="saveReminder()"></button>
    </ng-template>
</p-dialog>

<p-dialog [(visible)]="deleteReminderDialog" header="{{ 'shared.headers.delete' | translate }}" [modal]="true" [style]="{width:'450px'}">
    <div class="flex align-items-center justify-content-center">
        <i class="pi pi-exclamation-triangle mr-3" style="font-size: 2rem"></i>
        <span *ngIf="reminder">{{ 'shared.messages.delete' | translate }} <b>{{reminder.title}}</b>?</span>
    </div>
    <ng-template pTemplate="footer">
        <button pButton pRipple icon="pi pi-times" class="p-button-text" label="{{ 'shared.actions.cancel' | translate }}" (click)="deleteReminderDialog = false"></button>
        <button pButton pRipple icon="pi pi-check" class="p-button-text" label="{{ 'shared.actions.save' | translate }}"  (click)="confirmDelete( )"></button>
    </ng-template>
</p-dialog>

<p-dialog [(visible)]="deleteRemindersDialog" header="{{ 'shared.headers.delete' | translate }}" [modal]="true" [style]="{width:'450px'}">
    <div class="flex align-items-center justify-content-center">
        <i class="pi pi-exclamation-triangle mr-3" style="font-size: 2rem"></i>
        <span>{{ 'subscription.payment-reminder-list.message.deleteAll' | translate }}</span>
    </div>
    <ng-template pTemplate="footer">
        <button pButton pRipple icon="pi pi-times" class="p-button-text" label="{{ 'shared.actions.cancel' | translate }}" (click)="deleteRemindersDialog = false"></button>
        <button pButton pRipple icon="pi pi-check" class="p-button-text" label="{{ 'shared.actions.save' | translate }}" (click)="confirmDeleteSelected()"></button>
    </ng-template>
</p-dialog>

<p-dialog [(visible)]="activationDialog" header="{{ 'shared.headers.active' | translate }}" [modal]="true"
  [style]="{width:'450px'}">
  <div class="flex align-items-center justify-content-center">
    <i class="pi pi-exclamation-triangle mr-3" style="font-size: 2rem"></i>
    @if (reminder.isActive) {
    <span> {{ 'shared.messages.deactive' | translate }}  <b>{{reminder.title}}</b></span>
    }@else {
    <span>{{ 'shared.messages.active' | translate }}  <b>{{reminder.title}}</b></span>
    }
  </div>
  <ng-template pTemplate="footer">
    <button pButton pRipple icon="pi pi-times" class="p-button-text" label="{{ 'shared.actions.cancel' | translate }}" (click)="activationDialog = false"></button>
    <button pButton pRipple icon="pi pi-check" class="p-button-text" label="{{ 'shared.actions.save' | translate }}"
      (click)="toggleActive(reminder)"></button>
  </ng-template>
</p-dialog>