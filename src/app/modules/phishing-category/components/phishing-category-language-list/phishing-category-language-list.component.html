<div class="grid">
    <div class="col-12">
        <div class="card">
            <p-toast></p-toast>
            <div class="iAware-loading-table-container" style="position: relative">
                <app-table-loading-spinner *ngIf="tableLoadingSpinner"></app-table-loading-spinner>
                <p-table #dt 
                    [value]="phishingCategoryLanguages" 
                    responsiveLayout="scroll" 
                    [rows]="9"
                    [paginator]="true" 
                    [rowsPerPageOptions]="[10, 20, 30]" 
                    [expandedRowKeys]="expandedRows"
                    styleClass="p-datatable-striped"
                    dataKey="name"
                    [globalFilterFields]="['name', 'description']">
                    <ng-template pTemplate="caption">
                        <div class="flex flex-column md:flex-row md:justify-content-between md:align-items-center">
                            <h5 class="m-0">
                                {{ 'phishing-category.phishing-category-language-list.title' | translate }}
                            </h5>
                            <div class="my-1">
                                <button pButton pRipple *ngIf="!defaultPhishingCategories && !isIAwareTeamUser"
                                    label="{{ 'phishing-category.phishing-category-language-list.add' | translate }}"
                                    icon="pi pi-plus" class="p-button-success mr-2"
                                    (click)="CreatePhishingCategory()" [disabled]="activeLanguage.length === 0"></button>

                                <button pButton pRipple *ngIf="defaultPhishingCategories && isIAwareTeamUser"
                                    label="{{ 'phishing-category.phishing-category-language-list.add' | translate }}"
                                    icon="pi pi-plus" class="p-button-success mr-2"
                                    (click)="CreatePhishingCategory()"></button>

                                <span class="mt-2 md:mt-0 p-input-icon-left">
                                    <i class="pi pi-search"></i>
                                    <input pInputText type="text" (input)="onGlobalFilter(dt, $event)"
                                        placeholder="{{ 'shared.search.phishingCategory' | translate }}"
                                        class="w-full sm:w-auto" />
                                </span>
                            </div>
                        </div>
                    </ng-template>
                    <ng-template pTemplate="header">
                        <tr>
                            <th pSortableColumn="languageName">
                                {{ 'phishing-category.phishing-category-language-list.language' | translate }}
                                <p-sortIcon field="languageName"></p-sortIcon>
                                <p-columnFilter type="text" field="languageName" display="menu"></p-columnFilter>
                            </th>
                            <th pSortableColumn="name">
                                {{ 'phishing-category.phishing-category-language-list.name' | translate }}
                                <p-sortIcon field="name"> </p-sortIcon>
                                <p-columnFilter type="text" field="name" display="menu"></p-columnFilter>
                            </th>
                            <th style="text-align: center" pSortableColumn="CategoryBannerUrl">
                                {{ 'phishing-category.phishing-category-language-list.banner' | translate }}
                                <p-sortIcon field="CategoryBannerUrl"></p-sortIcon>
                                <p-columnFilter type="text" field="CategoryBannerUrl" display="menu"></p-columnFilter>
                            </th>
                            <th style="text-align: center">
                                {{ 'phishing-category.phishing-category-language-list.description' | translate }}
                            </th>
                            <th style="text-align: center">
                                {{ 'phishing-category.phishing-category-language-list.pageContnt' | translate }}
                            </th>
                            <th class="text-center">
                                {{ 'shared.actions.action' | translate }}
                            </th>
                            <th></th>
                        </tr>
                    </ng-template>
                    <ng-template pTemplate="body" let-cat let-expanded="expanded">
                        <tr>
                            <td>
                                <button
                                    type="button"
                                    pButton
                                    pRipple
                                    [pRowToggler]="cat"
                                    class="p-button-text p-button-rounded p-button-plain"
                                    [icon]="expanded ? 'pi pi-chevron-down' : 'pi pi-chevron-right'"></button>
                            </td>
                            <td>{{ cat.languageName }}</td>
                            <td>{{ cat.name }}</td>
                            <td style="text-align: center">
                                <p-image [src]="cat.categoryBannerUrl" alt="Image" width="100" [preview]="true" />
                            </td>
                            <td style="text-align: center">
                                <a style="cursor: pointer">
                                    <i class="pi pi-file-o" (click)="openContent(cat, 'description')"></i>
                                </a>
                            </td>
                            <td style="text-align: center">
                                <a style="cursor: pointer">
                                    <i class="pi pi-file-edit" (click)="openContent(cat, 'html')"></i>
                                </a>
                            </td>
                            <td style="text-align: center">
                                <div class="text-right">
                                    <button *ngIf="normalMenuItems.length > 0 && !cat.canEdit" pButton pRipple
                                        type="button" icon="pi pi-ellipsis-v"
                                        class="p-button-rounded p-button-text p-button-plain"
                                        (click)="normalMenu.toggle($event); assigneCurrentSelect(cat)"></button>

                                    <button *ngIf="ownerMenuItems.length > 0 && cat.canEdit" pButton pRipple
                                        type="button" icon="pi pi-ellipsis-v"
                                        class="p-button-rounded p-button-text p-button-plain"
                                        (click)="ownerMenu.toggle($event); assigneCurrentSelect(cat)"></button>

                                    <p-menu #ownerMenu [model]="ownerMenuItems" [appendTo]="'body'"
                                        [popup]="true"></p-menu>

                                    <p-menu #normalMenu [model]="normalMenuItems" [appendTo]="'body'"
                                        [popup]="true"></p-menu>
                                </div>
                            </td>
                        </tr>
                    </ng-template>
                    <ng-template pTemplate="rowexpansion" let-cat>
                        <tr>
                            <td colspan="7">
                                <div class="p-3">
                                    <p-dataView #dv [value]="cat.phishingEmailTemplates ?? []" [paginator]="true" [rows]="9" layout="grid">
                                        <ng-template let-templates pTemplate="gridItem">
                                            <div class="iAware-loading-table-container" style="position: relative">
                                                <app-table-loading-spinner *ngIf="tableLoadingSpinner"></app-table-loading-spinner>
                                                <div class="grid grid-nogutter">
                        
                                                    <div class="col-12 md:col-4" *ngFor="let template of templates">
                                                        <div class="p-3 m-3">
                                                            <div class="surface-card shadow-3 border-round overflow-hidden hover:shadow-5 transition-all relative">
                                                                <div class="relative object-cover">
                                                                    <img [src]="template.phishingEmailImageUrl" [alt]="template.emailName" class="w-full"/>
                                                                    <div *ngIf="template.isLocked" class="lock-overlay">
                                                                        <div class="lock-background"></div>
                                                                        <img src="/assets/media/Locker.png" alt="Locked" class="lock-icon" />

                                                                        <div class="upgrade-overlay">
                                                                            <div class="upgrade-content">
                                                                                <p class="upgrade-title text-lg font-bold">
                                                                                    {{ 'phishing-email-template.upgradeYourPlan' | translate }}
                                                                                </p>
                                                                                <p class="upgrade-description">
                                                                                    {{ 'phishing-email-template.upgradeMessage' | translate }}
                                                                                </p>
                                                                                <a
                                                                                    [routerLink]="['/users/profile']"
                                                                                    [queryParams]="{ tapIndex: 2 }"
                                                                                    class="upgrade-button"
                                                                                    >{{ 'phishing-email-template.upgradeBtn' | translate }}</a
                                                                                >
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                                <div class="text-center p-3">
                                                                    <a *ngIf="!template.isLocked" [routerLink]="['/phishing-templates', template.id, template.canEdit? 'defaultPhishingTemplates' : 'companyPhishingTemplates']">{{template.emailName}}</a>
                                                                    <a class="text-2xl font-bold" *ngIf="template.isLocked">{{ template.emailName }}</a>
                                                                    <p>{{ template.phishingEmailDescription }}</p>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </ng-template>
                                    </p-dataView>
                                </div>
                            </td>
                        </tr>
                    </ng-template>
                </p-table>
            </div>
        </div>
    </div>
</div>

<p-dialog [(visible)]="addpPishingCategoryLanguageDialog" [style]="{ width: '70%', height: '85%' }"
    header="{{ 'phishing-category.phishing-category-language-list.editHeader' | translate }}" [modal]="true"
    class="p-fluid">
    <ng-template pTemplate="content">
        <div class="card">
            <form [formGroup]="addPhishingCategoryLanguageForm" (ngSubmit)="addPhishingCategoryLanguage()">
                <div class="grid">
                    <div class="col-12">
                        <div class="grid formgrid p-fluid">

                            <div class="field col-12 md:col-6">
                                <label for="name" class="font-medium text-900">{{
                                    'phishing-category.phishing-category-language-list.name' | translate
                                    }}</label>
                                <input type="text" pInputText id="name" formControlName="name"
                                    placeholder="{{'phishing-category.phishing-category-language-list.nameField' | translate}}"
                                    required [ngClass]="{
                                        'ng-invalid ng-dirty':
                                            submitted && !addPhishingCategoryLanguageForm.controls['name'].valid
                                    }" />
                                <small *ngIf="submitted && !addPhishingCategoryLanguageForm.controls['name'].valid"
                                    class="ng-dirty ng-invalid text-red-500">{{
                                    'phishing-category.phishing-category-language-list.validations.name' | translate
                                    }}</small>
                            </div>

                            <div class="field col-12 md:col-6">
                                <label for="languageId" class="font-medium text-900">{{
                                    'phishing-category.phishing-category-language-list.language' | translate
                                    }}</label>
                                <span>
                                    <p-dropdown formControlName="languageId" [options]="activeLanguage"
                                        optionLabel="name" optionValue="id" placeholder="{{
                                            'phishing-category.phishing-category-language-list.languagePlaceholder'
                                                | translate
                                        }}">
                                    </p-dropdown>
                                </span>
                            </div>

                            <div class="field col-12">
                                <label class="font-medium text-900" for="categoryDescription">{{
                                    'phishing-category.phishing-category-language-list.description' | translate
                                    }}</label>
                                <textarea id="categoryDescription" name="categoryDescription"
                                    formControlName="categoryDescription"
                                    placeholder="{{'phishing-category.phishing-category-language-list.descriptionField' | translate}}"
                                    pInputTextarea required [ngClass]="{
                                        'ng-invalid ng-dirty':
                                            submitted &&
                                            !addPhishingCategoryLanguageForm.controls['categoryDescription'].valid
                                    }" rows="3" cols="50"></textarea>
                                <small *ngIf="
                                        submitted &&
                                        !addPhishingCategoryLanguageForm.controls['categoryDescription'].valid
                                    " class="ng-dirty ng-invalid text-red-500">{{
                                    'phishing-category.phishing-category-language-list.validations.description'
                                    | translate
                                    }}</small>
                            </div>

                            <div class="field col-12">
                                <label class="font-medium text-900" for="categoryPageContentHtml">{{
                                    'phishing-category.phishing-category-language-list.pageContnt' | translate
                                    }}</label>
                                <app-iAware-rich-text
                                    placeholder="{{'phishing-category.phishing-category-language-list.categoryPageContentHtmlPlaceholder' | translate}}"
                                    [id]="'categoryPageContentHtml'"
                                    formControlName="categoryPageContentHtml"></app-iAware-rich-text>
                                <small *ngIf="
                                        submitted &&
                                        !addPhishingCategoryLanguageForm.controls['categoryPageContentHtml'].valid
                                    " class="ng-dirty ng-invalid text-red-500">{{
                                    'phishing-category.phishing-category-language-list.validations.pageContent'
                                    | translate
                                    }}</small>
                            </div>

                            <div class="col-12 mt-2">

                                <p-panel
                                    header="{{'phishing-category.phishing-category-language-list.bannerField' | translate}}"
                                    class="mb-3">
                                    <div class="flex align-items-center justify-content-center">
                                        <img [src]="imageUrl" alt="Avatar" class="avatar" style="cursor: pointer"
                                            (click)="onUploadCategoryBannerClickAdd()" />
                                    </div>

                                    <!-- Recommended Dimensions -->
                                    <small class="text-center block m-2">{{ 'shared.messages.recommendedDimensions' |
                                        translate}} <strong>{{ 'shared.messages.1200x300' | translate}}</strong> {{
                                        'shared.messages.pixels' | translate}}</small>

                                    <div class="flex align-items-center justify-content-center mt-2"
                                        style="display: none">
                                        <p-button label="{{ 'shared.actions.upload' | translate }}" icon="pi pi-upload"
                                            (click)="onUploadCategoryBannerClickAdd()"></p-button>
                                        <input type="file" id="myCategoryBannerAdd" style="display: none"
                                            (change)="onCategoryBannerSelectedAdd($event)" />
                                    </div>
                                </p-panel>
                            </div>

                        </div>
                    </div>
                </div>
            </form>
        </div>
    </ng-template>
    <ng-template pTemplate="footer">
        <button pButton pRipple label="{{ 'shared.actions.cancel' | translate }}" icon="pi pi-times"
            class="p-button-text" (click)="addpPishingCategoryLanguageDialog = false"></button>
        <button pButton pRipple label="{{ 'shared.actions.save' | translate }}" icon="pi pi-check" class="p-button-text"
            (click)="addPhishingCategoryLanguage()"></button>
    </ng-template>
</p-dialog>

<p-dialog [(visible)]="editPhishingCategoryLanguageDialog" [style]="{ width: '70%', height: '85%' }"
    header="{{ 'phishing-category.phishing-category-language-list.editHeader' | translate }}" [modal]="true"
    class="p-fluid">
    <ng-template pTemplate="content">
        <div class="card">
            <form [formGroup]="editPhishingCategoryLanguageForm" (ngSubmit)="saveEditPhishingCategoryLanguage()">
                <div class="grid">
                    <div class="col-12">
                        <div class="grid formgrid p-fluid">

                            <div class="field col-12 md:col-6">
                                <label for="name" class="font-medium text-900">{{
                                    'phishing-category.phishing-category-language-list.name' | translate
                                    }}</label>
                                <input type="text" pInputText id="name" formControlName="name"
                                    placeholder="{{'phishing-category.phishing-category-language-list.nameField' | translate}}"
                                    required [ngClass]="{
                                        'ng-invalid ng-dirty':
                                            submitted && !editPhishingCategoryLanguageForm.controls['name'].valid
                                    }" />
                                <small *ngIf="submitted && !editPhishingCategoryLanguageForm.controls['name'].valid"
                                    class="ng-dirty ng-invalid text-red-500">{{
                                    'phishing-category.phishing-category-language-list.validations.name' | translate
                                    }}</small>
                            </div>

                            <div class="field col-12 md:col-6">
                                <label for="languageId" class="font-medium text-900">{{
                                    'phishing-category.phishing-category-language-list.language' | translate
                                    }}</label>
                                <span>
                                    <p-dropdown formControlName="languageId" [options]="activeLanguage"
                                        optionLabel="name" optionValue="id" placeholder="{{
                                            'phishing-category.phishing-category-language-list.languagePlaceholder'
                                                | translate
                                        }}">
                                    </p-dropdown>
                                </span>
                            </div>

                            <div class="field col-12">
                                <label class="font-medium text-900" for="categoryDescription">{{
                                    'phishing-category.phishing-category-language-list.description' | translate
                                    }}</label>
                                <textarea id="categoryDescription" name="categoryDescription"
                                    formControlName="categoryDescription"
                                    placeholder="{{'phishing-category.phishing-category-language-list.descriptionField' | translate}}"
                                    pInputTextarea required [ngClass]="{
                                        'ng-invalid ng-dirty':
                                            submitted &&
                                            !editPhishingCategoryLanguageForm.controls['categoryDescription'].valid
                                    }" rows="3" cols="50"></textarea>
                                <small *ngIf="
                                        submitted &&
                                        !editPhishingCategoryLanguageForm.controls['categoryDescription'].valid
                                    " class="ng-dirty ng-invalid text-red-500">{{
                                    'phishing-category.phishing-category-language-list.validations.description'
                                    | translate
                                    }}</small>
                            </div>

                            <div class="field col-12">
                                <label class="font-medium text-900" for="categoryPageContentHtml">{{
                                    'phishing-category.phishing-category-language-list.pageContnt' | translate
                                    }}</label>

                                <app-iAware-rich-text
                                    placeholder="{{'phishing-category.phishing-category-language-list.categoryPageContentHtmlPlaceholder' | translate}}"
                                    [id]="'categoryPageContentHtml'"
                                    formControlName="categoryPageContentHtml"></app-iAware-rich-text>

                                <small *ngIf="
                                        submitted &&
                                        !editPhishingCategoryLanguageForm.controls['categoryPageContentHtml'].valid
                                    " class="ng-dirty ng-invalid text-red-500">{{
                                    'phishing-category.phishing-category-language-list.validations.pageContent'
                                    | translate
                                    }}</small>
                            </div>

                            <div class="col-12 mt-2">

                                <p-panel
                                    header="{{'phishing-category.phishing-category-language-list.bannerField' | translate}}"
                                    class="mb-3">
                                    <div class="flex align-items-center justify-content-center">
                                        <img [src]="imageUrl" alt="Avatar" class="avatar" style="cursor: pointer"
                                            (click)="onUploadCategoryBannerClick()" />
                                    </div>

                                    <!-- Recommended Dimensions -->
                                    <small class="text-center block m-2">{{ 'shared.messages.recommendedDimensions' |
                                        translate}} <strong>{{ 'shared.messages.1200x300' | translate}}</strong> {{
                                        'shared.messages.pixels' | translate}}</small>

                                    <div class="flex align-items-center justify-content-center mt-2"
                                        style="display: none">
                                        <p-button label="{{ 'shared.actions.upload' | translate }}" icon="pi pi-upload"
                                            (click)="onUploadCategoryBannerClick()"></p-button>
                                        <input type="file" id="myCategoryBanner" style="display: none"
                                            (change)="onCategoryBannerSelected($event)" />
                                    </div>
                                </p-panel>
                            </div>

                        </div>
                    </div>
                </div>
            </form>
        </div>
    </ng-template>
    <ng-template pTemplate="footer">
        <button pButton pRipple label="{{ 'shared.actions.cancel' | translate }}" icon="pi pi-times"
            class="p-button-text" (click)="declineEditPhishingCategoryLanguage()"></button>
        <button pButton pRipple label="{{ 'shared.actions.save' | translate }}" icon="pi pi-check" class="p-button-text"
            (click)="saveEditPhishingCategoryLanguage()"></button>
    </ng-template>
</p-dialog>

<p-dialog [(visible)]="deletionPhishingCategoryLanguageDialog" header="{{ 'shared.headers.delete' | translate }}"
    [modal]="true" [style]="{ width: '450px' }">
    <div class="flex align-items-center justify-content-center">
        <i class="pi pi-exclamation-triangle mr-3" style="font-size: 2rem"></i>
        <span *ngIf="phishingCategoryLanguage">{{ 'shared.messages.delete' | translate }}
            <b>{{ phishingCategoryLanguage.name }}</b>
            ?</span>
    </div>
    <ng-template pTemplate="footer">
        <button pButton pRipple icon="pi pi-times" class="p-button-text"
            label="{{ 'shared.actions.cancel' | translate }}" (click)="declineDeletion()"></button>
        <button pButton pRipple icon="pi pi-check" class="p-button-text" label="{{ 'shared.actions.save' | translate }}"
            (click)="confirmDeletion()"></button>
    </ng-template>
</p-dialog>

<p-dialog [(visible)]="switchActivationPhishingCategoryLanguageDialog"
    header="{{ 'shared.headers.active' | translate }}" [modal]="true" [style]="{ width: '450px' }">
    <div class="flex align-items-center justify-content-center">
        <i class="pi pi-exclamation-triangle mr-3" style="font-size: 2rem"></i>
        @if (phishingCategoryLanguage && phishingCategoryLanguage.isActive) {
        <span>{{ 'shared.messages.deactive' | translate }} <b>{{ phishingCategoryLanguage.name }}</b></span>
        }@else {
        <span>{{ 'shared.messages.active' | translate }} <b>{{ phishingCategoryLanguage.name }}</b></span>
        }
    </div>
    <ng-template pTemplate="footer">
        <button pButton pRipple icon="pi pi-times" class="p-button-text"
            label="{{ 'shared.actions.cancel' | translate }}" (click)="declineActivation()"></button>
        <button pButton pRipple icon="pi pi-check" class="p-button-text" label="{{ 'shared.actions.save' | translate }}"
            (click)="confirmtActivation()"></button>
    </ng-template>
</p-dialog>

<p-dialog [(visible)]="openCategoryPageContentHtmlDialog" [modal]="true" [style]="{ width: '450px' }">
    <div class="flex align-items-center justify-content-center">
        <span *ngIf="phishingCategoryLanguage && displayContentType === 'html'"
            [innerHTML]="phishingCategoryLanguage.categoryPageContentHtml"></span>
        <span *ngIf="phishingCategoryLanguage && displayContentType === 'description'"
            [innerHTML]="phishingCategoryLanguage.categoryDescription"></span>
    </div>
    <ng-template pTemplate="footer">
        <button pButton pRipple icon="pi pi-times" class="p-button-text"
            label="{{ 'shared.actions.cancel' | translate }}" (click)="hideCategoryPageContentHtmlDialog()"></button>
    </ng-template>
</p-dialog>